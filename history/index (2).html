<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Trustline Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.7/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/12.0.0/stellar-sdk.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const server = new StellarSdk.Horizon.Server('https://horizon.stellar.org');
        const BACKEND_URL = 'http://localhost:3000'; // Update for production

        // Resolve federation address to public key
        async function resolveFederationAddress(federationAddress) {
            try {
                const federationServer = new StellarSdk.FederationServer('https://federation.stellar.org');
                const response = await federationServer.resolve(federationAddress);
                return response.account_id;
            } catch (error) {
                throw new Error(`Failed to resolve federation address: ${error.message}`);
            }
        }

        // Load account trustlines
        async function loadTrustlines(publicKey) {
            try {
                const account = await server.loadAccount(publicKey);
                const trustlines = account.balances
                    .filter(balance => balance.asset_type !== 'native')
                    .map(balance => ({
                        assetCode: balance.asset_code,
                        assetIssuer: balance.asset_issuer,
                        creationDate: null // Placeholder for creation date
                    }));

                // Fetch creation dates from transaction history
                const transactions = server.transactions().forAccount(publicKey).order('desc').limit(100);
                let cursor = null;
                const trustlineMap = new Map(trustlines.map(t => [`${t.assetCode}:${t.assetIssuer}`, t]));

                while (trustlineMap.size > 0) {
                    const txResponse = cursor
                        ? await transactions.cursor(cursor).call()
                        : await transactions.call();
                    if (!txResponse.records || txResponse.records.length === 0) break;

                    for (const tx of txResponse.records) {
                        const operations = await server.operations().forTransaction(tx.id).call();
                        for (const op of operations.records) {
                            if (op.type === 'change_trust' && op.asset_code && op.asset_issuer) {
                                const key = `${op.asset_code}:${op.asset_issuer}`;
                                if (trustlineMap.has(key)) {
                                    trustlineMap.get(key).creationDate = new Date(op.created_at);
                                    trustlineMap.delete(key);
                                }
                            }
                        }
                    }
                    cursor = txResponse.next ? (await txResponse.next()).cursor : null;
                    if (!cursor) break;
                }

                return trustlines;
            } catch (error) {
                throw new Error(`Failed to load account ${publicKey}: ${error.message}`);
            }
        }

        const App = () => {
            const [sourceInput, setSourceInput] = useState('');
            const [sourcePublicKey, setSourcePublicKey] = useState('');
            const [sourceSecret, setSourceSecret] = useState('');
            const [destinationPublicKey, setDestinationPublicKey] = useState('');
            const [issuerAddress, setIssuerAddress] = useState('');
            const [menuOption, setMenuOption] = useState(null);
            const [trustlines, setTrustlines] = useState([]);
            const [results, setResults] = useState([]);
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showConfirm, setShowConfirm] = useState(false);
            const [confirmAction, setConfirmAction] = useState(null);
            const [sortBy, setSortBy] = useState('assetCodeAsc');
            const [filterIssuer, setFilterIssuer] = useState('');

            // Handle source address input (federation or public key)
            const handleSourceSubmit = async () => {
                setError('');
                setIsLoading(true);
                try {
                    let publicKey = sourceInput;
                    if (sourceInput.includes('*')) {
                        publicKey = await resolveFederationAddress(sourceInput);
                    } else if (!StellarSdk.StrKey.isValidEd25519PublicKey(sourceInput)) {
                        throw new Error('Invalid public key or federation address.');
                    }
                    setSourcePublicKey(publicKey);
                    setTrustlines(await loadTrustlines(publicKey));
                    setMenuOption(null);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Handle menu option selection
            const handleMenuOption = (option) => {
                setMenuOption(option);
                setError('');
                setResults([]);
                setDestinationPublicKey('');
                setIssuerAddress('');
                setSourceSecret('');
                setFilterIssuer('');
                setSortBy('assetCodeAsc');
            };

            // Sort and filter trustlines
            const getSortedAndFilteredTrustlines = (trustlines) => {
                let filtered = trustlines;
                if (filterIssuer && StellarSdk.StrKey.isValidEd25519PublicKey(filterIssuer)) {
                    filtered = trustlines.filter(t => t.assetIssuer === filterIssuer);
                }
                return filtered.sort((a, b) => {
                    if (sortBy === 'assetCodeAsc') {
                        return a.assetCode.localeCompare(b.assetCode);
                    } else if (sortBy === 'assetCodeDesc') {
                        return b.assetCode.localeCompare(a.assetCode);
                    } else if (sortBy === 'dateAsc') {
                        const dateA = a.creationDate ? a.creationDate.getTime() : Infinity;
                        const dateB = b.creationDate ? b.creationDate.getTime() : Infinity;
                        return dateA - dateB;
                    } else if (sortBy === 'dateDesc') {
                        const dateA = a.creationDate ? a.creationDate.getTime() : -Infinity;
                        const dateB = b.creationDate ? b.creationDate.getTime() : -Infinity;
                        return dateB - dateA;
                    }
                    return 0;
                });
            };

            // Handle list all trustlines
            const handleListAllTrustlines = async () => {
                setError('');
                setIsLoading(true);
                try {
                    const trustlines = await loadTrustlines(sourcePublicKey);
                    if (trustlines.length > 0) {
                        setResults(trustlines);
                    } else {
                        setResults(['No trustlines found.']);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Handle compare trustlines
            const handleCompareTrustlines = async () => {
                if (!destinationPublicKey || !StellarSdk.StrKey.isValidEd25519PublicKey(destinationPublicKey)) {
                    setError('Invalid destination public key.');
                    return;
                }
                setError('');
                setIsLoading(true);
                try {
                    const sourceTrustlines = await loadTrustlines(sourcePublicKey);
                    const destTrustlines = await loadTrustlines(destinationPublicKey);
                    const duplicates = sourceTrustlines.filter(source =>
                        destTrustlines.some(dest =>
                            dest.assetCode === source.assetCode && dest.assetIssuer === source.assetIssuer
                        )
                    );
                    if (duplicates.length > 0) {
                        setResults(duplicates);
                        setConfirmAction(() => async () => {
                            if (!sourceSecret || !StellarSdk.StrKey.isValidEd25519SecretSeed(sourceSecret)) {
                                setError('Invalid source secret key.');
                                return;
                            }
                            try {
                                const response = await fetch(`${BACKEND_URL}/delete-trustlines`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ secretKey: sourceSecret, trustlines: duplicates })
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(result.error || 'Failed to delete trustlines.');
                                setResults([...result.messages, 'Secret key has been cleared.']);
                                setTrustlines(await loadTrustlines(sourcePublicKey));
                                setSourceSecret('');
                            } catch (err) {
                                setError(err.message);
                            }
                        });
                        setShowConfirm(true);
                    } else {
                        setResults(['No duplicate trustlines found.']);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Handle delete all trustlines
            const handleDeleteAllTrustlines = async () => {
                setError('');
                setIsLoading(true);
                try {
                    const trustlines = await loadTrustlines(sourcePublicKey);
                    if (trustlines.length > 0) {
                        setResults(trustlines);
                        setConfirmAction(() => async () => {
                            if (!sourceSecret || !StellarSdk.StrKey.isValidEd25519SecretSeed(sourceSecret)) {
                                setError('Invalid source secret key.');
                                return;
                            }
                            try {
                                const response = await fetch(`${BACKEND_URL}/delete-trustlines`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ secretKey: sourceSecret, trustlines })
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(result.error || 'Failed to delete trustlines.');
                                setResults([...result.messages, 'Secret key has been cleared.']);
                                setTrustlines([]);
                                setSourceSecret('');
                            } catch (err) {
                                setError(err.message);
                            }
                        });
                        setShowConfirm(true);
                    } else {
                        setResults(['No trustlines found.']);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Handle delete trustlines by issuer
            const handleDeleteByIssuer = async () => {
                if (!issuerAddress || !StellarSdk.StrKey.isValidEd25519PublicKey(issuerAddress)) {
                    setError('Invalid issuer address.');
                    return;
                }
                setError('');
                setIsLoading(true);
                try {
                    const trustlines = await loadTrustlines(sourcePublicKey);
                    const issuerTrustlines = trustlines.filter(t => t.assetIssuer === issuerAddress);
                    if (issuerTrustlines.length > 0) {
                        setResults(issuerTrustlines);
                        setConfirmAction(() => async () => {
                            if (!sourceSecret || !StellarSdk.StrKey.isValidEd25519SecretSeed(sourceSecret)) {
                                setError('Invalid source secret key.');
                                return;
                            }
                            try {
                                const response = await fetch(`${BACKEND_URL}/delete-trustlines`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ secretKey: sourceSecret, trustlines: issuerTrustlines })
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(result.error || 'Failed to delete trustlines.');
                                setResults([...result.messages, 'Secret key has been cleared.']);
                                setTrustlines(await loadTrustlines(sourcePublicKey));
                                setSourceSecret('');
                            } catch (err) {
                                setError(err.message);
                            }
                        });
                        setShowConfirm(true);
                    } else {
                        setResults([`No trustlines found for issuer ${issuerAddress}.`]);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Render confirmation modal
            const ConfirmationModal = () => (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                        <h2 className="text-xl font-bold mb-4">Confirm Action</h2>
                        <p className="mb-4">Are you sure you want to delete the listed trustlines? Your secret key will be sent to a secure backend and not stored.</p>
                        <div className="flex justify-end space-x-4">
                            <button
                                onClick={async () => {
                                    setIsLoading(true);
                                    try {
                                        await confirmAction();
                                        setShowConfirm(false);
                                    } catch (err) {
                                        setError(err.message);
                                    } finally {
                                        setIsLoading(false);
                                    }
                                }}
                                className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                                disabled={isLoading}
                            >
                                Yes
                            </button>
                            <button
                                onClick={() => {
                                    setShowConfirm(false);
                                    setResults([]);
                                    setSourceSecret('');
                                    setResults(['Secret key has been cleared.']);
                                }}
                                className="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="container mx-auto p-4">
                    <h1 className="text-2xl font-bold mb-4">Stellar Trustline Manager</h1>
                    <p className="mb-4 text-sm text-gray-600">Secret keys are securely handled by the backend and never stored.</p>
                    {!sourcePublicKey ? (
                        <div className="mb-4">
                            <label className="block mb-2">Enter Source Federation Address or Public Key:</label>
                            <input
                                type="text"
                                value={sourceInput}
                                onChange={(e) => setSourceInput(e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder="e.g., user*example.com or GD4TPVR..."
                            />
                            <button
                                onClick={handleSourceSubmit}
                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                disabled={isLoading}
                            >
                                {isLoading ? 'Loading...' : 'Submit'}
                            </button>
                        </div>
                    ) : (
                        <div>
                            <p className="mb-4">Source Wallet: {sourcePublicKey}</p>
                            {!menuOption ? (
                                <div className="space-y-2">
                                    <button
                                        onClick={() => handleMenuOption('listAll')}
                                        className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
                                    >
                                        List All Trustlines
                                    </button>
                                    <button
                                        onClick={() => handleMenuOption('compare')}
                                        className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
                                    >
                                        Compare Trustlines
                                    </button>
                                    <button
                                        onClick={() => handleMenuOption('deleteAll')}
                                        className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
                                    >
                                        Delete All Trustlines
                                    </button>
                                    <button
                                        onClick={() => handleMenuOption('deleteByIssuer')}
                                        className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
                                    >
                                        Delete Trustlines by Issuer
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    <button
                                        onClick={() => setMenuOption(null)}
                                        className="mb-4 bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
                                    >
                                        Back to Menu
                                    </button>
                                    {menuOption === 'listAll' && (
                                        <div>
                                            <div className="mb-4 flex space-x-4">
                                                <div>
                                                    <label className="block mb-2">Sort By:</label>
                                                    <select
                                                        value={sortBy}
                                                        onChange={(e) => setSortBy(e.target.value)}
                                                        className="p-2 border rounded"
                                                    >
                                                        <option value="assetCodeAsc">Asset Code (A-Z)</option>
                                                        <option value="assetCodeDesc">Asset Code (Z-A)</option>
                                                        <option value="dateAsc">Creation Date (Oldest First)</option>
                                                        <option value="dateDesc">Creation Date (Newest First)</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block mb-2">Filter by Issuer:</label>
                                                    <input
                                                        type="text"
                                                        value={filterIssuer}
                                                        onChange={(e) => setFilterIssuer(e.target.value)}
                                                        className="w-full p-2 border rounded"
                                                        placeholder="e.g., GA5ZSEJ..."
                                                    />
                                                </div>
                                            </div>
                                            <button
                                                onClick={handleListAllTrustlines}
                                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                                disabled={isLoading}
                                            >
                                                {isLoading ? 'Loading...' : 'List Trustlines'}
                                            </button>
                                        </div>
                                    )}
                                    {menuOption === 'compare' && (
                                        <div>
                                            <label className="block mb-2">Enter Destination Public Key:</label>
                                            <input
                                                type="text"
                                                value={destinationPublicKey}
                                                onChange={(e) => setDestinationPublicKey(e.target.value)}
                                                className="w-full p-2 border rounded"
                                                placeholder="e.g., GBZVTOY..."
                                            />
                                            <button
                                                onClick={handleCompareTrustlines}
                                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                                disabled={isLoading}
                                            >
                                                {isLoading ? 'Loading...' : 'Compare Trustlines'}
                                            </button>
                                        </div>
                                    )}
                                    {menuOption === 'deleteAll' && (
                                        <div>
                                            <button
                                                onClick={handleDeleteAllTrustlines}
                                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                                disabled={isLoading}
                                            >
                                                {isLoading ? 'Loading...' : 'List Trustlines'}
                                            </button>
                                        </div>
                                    )}
                                    {menuOption === 'deleteByIssuer' && (
                                        <div>
                                            <label className="block mb-2">Enter Issuer Address:</label>
                                            <input
                                                type="text"
                                                value={issuerAddress}
                                                onChange={(e) => setIssuerAddress(e.target.value)}
                                                className="w-full p-2 border rounded"
                                                placeholder="e.g., GA5ZSEJ..."
                                            />
                                            <button
                                                onClick={handleDeleteByIssuer}
                                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                                disabled={isLoading}
                                            >
                                                {isLoading ? 'Loading...' : 'List Trustlines'}
                                            </button>
                                        </div>
                                    )}
                                    {menuOption !== 'listAll' && (
                                        <div className="mt-4">
                                            <label className="block mb-2">Enter Source Secret Key (sent securely to backend, not stored):</label>
                                            <input
                                                type="password"
                                                value={sourceSecret}
                                                onChange={(e) => setSourceSecret(e.target.value)}
                                                className="w-full p-2 border rounded"
                                                placeholder="e.g., SB..."
                                            />
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                    {error && <p className="text-red-500 mt-4">{error}</p>}
                    {results.length > 0 && (
                        <div className="mt-4">
                            <h2 className="text-xl font-bold">Results:</h2>
                            {typeof results[0] === 'string' ? (
                                <ul className="list-disc pl-5">
                                    {results.map((result, index) => (
                                        <li key={index}>{result}</li>
                                    ))}
                                </ul>
                            ) : (
                                <table className="w-full border-collapse border border-gray-300">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            <th className="border border-gray-300 p-2">Asset Code</th>
                                            <th className="border border-gray-300 p-2">Issuer</th>
                                            <th className="border border-gray-300 p-2">Creation Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {getSortedAndFilteredTrustlines(results).map((result, index) => (
                                            <tr key={index}>
                                                <td className="border border-gray-300 p-2">{result.assetCode}</td>
                                                <td className="border border-gray-300 p-2">{result.assetIssuer}</td>
                                                <td className="border border-gray-300 p-2">
                                                    {result.creationDate ? result.creationDate.toLocaleString() : 'Unknown'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    )}
                    {showConfirm && <ConfirmationModal />}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>