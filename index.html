<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Trustline Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.7/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/12.0.0/stellar-sdk.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const server = new StellarSdk.Horizon.Server('https://horizon.stellar.org');
        const BACKEND_URL = 'http://localhost:3000'; // Update for production
        const ITEMS_PER_PAGE = 333;

        // Available languages with flag emojis
        const availableLanguages = [
            { code: 'en', name: 'English', flag: 'ðŸ‡¬ðŸ‡§' },
            { code: 'de', name: 'German', flag: 'ðŸ‡©ðŸ‡ª' }
            // Add more languages as needed, e.g.:
            // { code: 'es', name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' },
            // { code: 'fr', name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
            // { code: 'it', name: 'Italian', flag: 'ðŸ‡®ðŸ‡¹' }
        ];

        // Translations
        const translations = {
            en: {
                title: "Stellar Trustline Manager",
                secretKeyInfo: "Secret keys are securely handled by the backend and never stored.",
                sourceLabel: "Enter Source Federation Address or Public Key:",
                sourcePlaceholder: "e.g., user*example.com or GD4TPVR...",
                submitButton: "Submit",
                loading: "Loading...",
                sourceWallet: "Source Wallet:",
                listAll: "List All Trustlines",
                compare: "Compare Trustlines",
                deleteAll: "Delete All Trustlines",
                deleteByIssuer: "Delete Trustlines by Issuer",
                backToMenu: "Back to Menu",
                listTrustlines: "List Trustlines",
                showAllTrustlines: "Show All Trustlines",
                destLabel: "Enter Destination Public Key:",
                destPlaceholder: "e.g., GBZVTOY...",
                compareTrustlines: "Compare Trustlines",
                issuerLabel: "Enter Issuer Address:",
                issuerPlaceholder: "e.g., GA5ZSEJ...",
                issuerSearchNoMatch: "No issuer addresses found matching '{search}'.",
                secretKeyLabel: "Enter Source Secret Key (sent securely to backend, not stored):",
                secretKeyPlaceholder: "e.g., SB...",
                show: "Show",
                hide: "Hide",
                deleteAllButton: "Delete All Trustlines",
                deleteByIssuerButton: "Delete Trustlines by Issuer",
                results: "Results:",
                noTrustlines: "No trustlines found.",
                noDuplicates: "No duplicate trustlines found.",
                noIssuer: "No trustlines found for issuer {issuer}.",
                assetCode: "Asset Code",
                issuer: "Issuer",
                creationDate: "Creation Date",
                unknownDate: "Unknown (created before available history)",
                previous: "Previous",
                next: "Next",
                backToTop: "Back to Top",
                confirmTitle: "Confirm Action",
                confirmMessage: "Are you sure you want to delete the listed trustlines? Your secret key will be sent to a secure backend and not stored.",
                yes: "Yes",
                cancel: "Cancel",
                currentMenu: "Current Menu:",
                secretKeyEmpty: "Secret key field is empty.",
                secretKeyInvalid: "Invalid secret key.",
                secretKeyMismatch: "Secret key does not match the public key.",
                secretKeyCleared: "Secret key has been cleared.",
                invalidPublicKey: "Invalid public key or federation address.",
                invalidIssuer: "Invalid issuer address.",
                // Error handling translations
                failedFederation: "Failed to resolve federation address: {error}",
                noBalances: "No balances found for account.",
                failedLoadAccount: "Failed to load account {publicKey}: {error}",
                backendConnectError: "Cannot connect to backend. Ensure the server is running at {url} and CORS is enabled.",
                failedDeleteTrustlines: "Failed to delete trustlines: {error}",
                scriptError: "Script error: {message} at {source}:{lineno}:{colno} - {error}",
                errorFetchingOperations: "Error fetching operations: {error}"
            },
            de: {
                title: "Stellar Trustline Manager",
                secretKeyInfo: "Geheime SchlÃ¼ssel werden sicher vom Backend verarbeitet und nicht gespeichert.",
                sourceLabel: "Geben Sie die Quell-FÃ¶derationsadresse oder den Ã¶ffentlichen SchlÃ¼ssel ein:",
                sourcePlaceholder: "z.B., user*example.com oder GD4TPVR...",
                submitButton: "Absenden",
                loading: "Laden...",
                sourceWallet: "Quell-Wallet:",
                listAll: "Alle Trustlines auflisten",
                compare: "Trustlines vergleichen",
                deleteAll: "Alle Trustlines lÃ¶schen",
                deleteByIssuer: "Trustlines nach Emittenten lÃ¶schen",
                backToMenu: "ZurÃ¼ck zum MenÃ¼",
                listTrustlines: "Trustlines auflisten",
                showAllTrustlines: "Alle Trustlines anzeigen",
                destLabel: "Geben Sie den Ziel-Ã¶ffentlichen SchlÃ¼ssel ein:",
                destPlaceholder: "z.B., GBZVTOY...",
                compareTrustlines: "Trustlines vergleichen",
                issuerLabel: "Geben Sie die Emittentenadresse ein:",
                issuerPlaceholder: "z.B., GA5ZSEJ...",
                issuerSearchNoMatch: "Keine Emittentenadressen gefunden, die '{search}' entsprechen.",
                secretKeyLabel: "Geben Sie den Quell-GeheimschlÃ¼ssel ein (wird sicher an das Backend gesendet, nicht gespeichert):",
                secretKeyPlaceholder: "z.B., SB...",
                show: "Anzeigen",
                hide: "Verbergen",
                deleteAllButton: "Alle Trustlines lÃ¶schen",
                deleteByIssuerButton: "Trustlines nach Emittenten lÃ¶schen",
                results: "Ergebnisse:",
                noTrustlines: "Keine Trustlines gefunden.",
                noDuplicates: "Keine doppelten Trustlines gefunden.",
                noIssuer: "Keine Trustlines fÃ¼r Emittenten {issuer} gefunden.",
                assetCode: "Asset-Code",
                issuer: "Emittent",
                creationDate: "Erstellungsdatum",
                unknownDate: "Unbekannt (vor verfÃ¼gbarer Historie erstellt)",
                previous: "Vorherige",
                next: "NÃ¤chste",
                backToTop: "ZurÃ¼ck nach oben",
                confirmTitle: "Aktion bestÃ¤tigen",
                confirmMessage: "Sind Sie sicher, dass Sie die aufgefÃ¼hrten Trustlines lÃ¶schen mÃ¶chten? Ihr geheimer SchlÃ¼ssel wird sicher an ein Backend gesendet und nicht gespeichert.",
                yes: "Ja",
                cancel: "Abbrechen",
                currentMenu: "Aktuelles MenÃ¼:",
                secretKeyEmpty: "GeheimschlÃ¼ssel-Feld ist leer.",
                secretKeyInvalid: "UngÃ¼ltiger GeheimschlÃ¼ssel.",
                secretKeyMismatch: "GeheimschlÃ¼ssel passt nicht zur Ã¶ffentlichen Adresse.",
                secretKeyCleared: "GeheimschlÃ¼ssel wurde gelÃ¶scht.",
                invalidPublicKey: "UngÃ¼ltiger Ã¶ffentlicher SchlÃ¼ssel oder FÃ¶derationsadresse.",
                invalidIssuer: "UngÃ¼ltige Emittentenadresse.",
                // Error handling translations
                failedFederation: "Fehler beim AuflÃ¶sen der FÃ¶derationsadresse: {error}",
                noBalances: "Keine Guthaben fÃ¼r das Konto gefunden.",
                failedLoadAccount: "Fehler beim Laden des Kontos {publicKey}: {error}",
                backendConnectError: "Keine Verbindung zum Backend mÃ¶glich. Stellen Sie sicher, dass der Server unter {url} lÃ¤uft und CORS aktiviert ist.",
                failedDeleteTrustlines: "Fehler beim LÃ¶schen der Trustlines: {error}",
                scriptError: "Skriptfehler: {message} bei {source}:{lineno}:{colno} - {error}",
                errorFetchingOperations: "Fehler beim Abrufen der Operationen: {error}"
            }
        };

        const App = () => {
            const [sourceInput, setSourceInput] = useState('');
            const [sourcePublicKey, setSourcePublicKey] = useState('');
            const [sourceSecret, setSourceSecret] = useState('');
            const [showSecretKey, setShowSecretKey] = useState(false);
            const [destinationPublicKey, setDestinationPublicKey] = useState('');
            const [issuerAddress, setIssuerAddress] = useState('');
            const [issuerSearchResults, setIssuerSearchResults] = useState([]);
            const [menuOption, setMenuOption] = useState(null);
            const [trustlines, setTrustlines] = useState([]);
            const [results, setResults] = useState([]);
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showConfirm, setShowConfirm] = useState(false);
            const [confirmAction, setConfirmAction] = useState(null);
            const [sortColumn, setSortColumn] = useState('assetCode');
            const [sortDirection, setSortDirection] = useState('asc');
            const [currentPage, setCurrentPage] = useState(0);
            const [showBackToTop, setShowBackToTop] = useState(false);
            const [language, setLanguage] = useState('en');

            const t = (key, params = {}) => {
                let text = translations[language][key] || key;
                Object.keys(params).forEach(param => {
                    text = text.replace(`{${param}}`, params[param]);
                });
                return text;
            };

            // Toggle language
            const toggleLanguage = (newLang) => {
                setLanguage(newLang);
            };

            // Global error handler
            useEffect(() => {
                const handleError = (message, source, lineno, colno, error) => {
                    console.error('Global error:', { message, source, lineno, colno, error });
                    setError(t('scriptError', {
                        message,
                        source,
                        lineno,
                        colno,
                        error: error ? error.message : ''
                    }));
                    return true;
                };
                window.onerror = handleError;
                return () => { window.onerror = null; };
            }, [language]);

            // Handle scroll for Back to Top button
            useEffect(() => {
                const handleScroll = () => {
                    setShowBackToTop(window.scrollY > 200);
                };
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            // Handle source address input
            const handleSourceSubmit = async () => {
                setError('');
                setIsLoading(true);
                try {
                    let publicKey = sourceInput;
                    if (sourceInput.includes('*')) {
                        publicKey = await resolveFederationAddress(sourceInput);
                    } else if (!StellarSdk.StrKey.isValidEd25519PublicKey(sourceInput)) {
                        throw new Error(t('invalidPublicKey'));
                    }
                    setSourcePublicKey(publicKey);
                    setTrustlines(await loadTrustlines(publicKey));
                    setMenuOption(null);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Handle menu option selection
            const handleMenuOption = (option) => {
                setMenuOption(option);
                setError('');
                setResults([]);
                setDestinationPublicKey('');
                setIssuerAddress('');
                setIssuerSearchResults([]);
                setSourceSecret('');
                setShowSecretKey(false);
                setSortColumn('assetCode');
                setSortDirection('asc');
                setCurrentPage(0);
            };

            // Sort trustlines
            const getSortedAndFilteredTrustlines = (trustlines) => {
                return [...trustlines].sort((a, b) => {
                    const isAsc = sortDirection === 'asc' ? 1 : -1;
                    if (sortColumn === 'assetCode') {
                        return a.assetCode.localeCompare(b.assetCode) * isAsc;
                    } else if (sortColumn === 'assetIssuer') {
                        return a.assetIssuer.localeCompare(b.assetIssuer) * isAsc;
                    } else if (sortColumn === 'creationDate') {
                        const dateA = a.creationDate ? a.creationDate.getTime() : (isAsc ? Infinity : -Infinity);
                        const dateB = b.creationDate ? b.creationDate.getTime() : (isAsc ? Infinity : -Infinity);
                        return (dateA - dateB) * isAsc;
                    }
                    return 0;
                });
            };

            // Handle header click for sorting
            const handleSort = (column) => {
                if (sortColumn === column) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortColumn(column);
                    setSortDirection('asc');
                }
                setCurrentPage(0);
            };

            // Get paginated trustlines
            const getPaginatedTrustlines = (trustlines) => {
                const startIndex = currentPage * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                return trustlines.slice(startIndex, endIndex);
            };

            // Handle list all trustlines
            const handleListAllTrustlines = async () => {
                setError('');
                setIsLoading(true);
                try {
                    const trustlines = await loadTrustlines(sourcePublicKey);
                    if (trustlines.length > 0) {
                        setResults(trustlines);
                    } else {
                        setResults([t('noTrustlines')]);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Handle compare trustlines
            const handleCompareTrustlines = async () => {
                if (!destinationPublicKey || !StellarSdk.StrKey.isValidEd25519PublicKey(destinationPublicKey)) {
                    setError(t('invalidPublicKey'));
                    return;
                }
                setError('');
                setIsLoading(true);
                try {
                    const sourceTrustlines = await loadTrustlines(sourcePublicKey);
                    const destTrustlines = await loadTrustlines(destinationPublicKey);
                    const duplicates = sourceTrustlines.filter(source =>
                        destTrustlines.some(dest =>
                            dest.assetCode === source.assetCode && dest.assetIssuer === source.assetIssuer
                        )
                    );
                    if (duplicates.length > 0) {
                        setResults(duplicates);
                        setConfirmAction(() => async () => {
                            if (!sourceSecret) {
                                setError(t('secretKeyEmpty'));
                                return;
                            }
                            if (!StellarSdk.StrKey.isValidEd25519SecretSeed(sourceSecret)) {
                                setError(t('secretKeyInvalid'));
                                return;
                            }
                            const keyPair = StellarSdk.Keypair.fromSecret(sourceSecret);
                            if (keyPair.publicKey() !== sourcePublicKey) {
                                setError(t('secretKeyMismatch'));
                                return;
                            }
                            try {
                                console.log('Sending fetch to:', BACKEND_URL + '/delete-trustlines');
                                console.log('Request body:', { secretKey: sourceSecret, trustlines: duplicates });
                                const response = await fetch(`${BACKEND_URL}/delete-trustlines`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ secretKey: sourceSecret, trustlines: duplicates })
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(t('failedDeleteTrustlines', { error: result.error || 'Unknown error' }));
                                setResults([...result.messages, t('secretKeyCleared')]);
                                setTrustlines(await loadTrustlines(sourcePublicKey));
                                setSourceSecret('');
                                setShowSecretKey(false);
                            } catch (err) {
                                console.error('Fetch error:', err);
                                setError(err.message.includes('Failed to fetch')
                                    ? t('backendConnectError', { url: BACKEND_URL })
                                    : err.message);
                            }
                        });
                        setShowConfirm(true);
                    } else {
                        setResults([t('noDuplicates')]);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Handle delete all trustlines
            const handleDeleteAllTrustlines = async () => {
                setError('');
                setIsLoading(true);
                try {
                    const trustlines = results; // Use displayed trustlines
                    if (trustlines.length > 0 && typeof trustlines[0] !== 'string') {
                        // Validate secret key first
                        if (!sourceSecret) {
                            setError(t('secretKeyEmpty'));
                            setIsLoading(false);
                            return;
                        }
                        if (!StellarSdk.StrKey.isValidEd25519SecretSeed(sourceSecret)) {
                            setError(t('secretKeyInvalid'));
                            setIsLoading(false);
                            return;
                        }
                        const keyPair = StellarSdk.Keypair.fromSecret(sourceSecret);
                        if (keyPair.publicKey() !== sourcePublicKey) {
                            setError(t('secretKeyMismatch'));
                            setIsLoading(false);
                            return;
                        }

                        setConfirmAction(() => async () => {
                            try {
                                console.log('Sending fetch to:', BACKEND_URL + '/delete-trustlines');
                                console.log('Request body:', { secretKey: sourceSecret, trustlines });
                                const response = await fetch(`${BACKEND_URL}/delete-trustlines`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ secretKey: sourceSecret, trustlines })
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(t('failedDeleteTrustlines', { error: result.error || 'Unknown error' }));
                                setResults([...result.messages, t('secretKeyCleared')]);
                                setTrustlines([]);
                                setSourceSecret('');
                                setShowSecretKey(false);
                            } catch (err) {
                                console.error('Fetch error:', err);
                                setError(err.message.includes('Failed to fetch')
                                    ? t('backendConnectError', { url: BACKEND_URL })
                                    : err.message);
                            }
                        });
                        setShowConfirm(true);
                    } else {
                        setResults([t('noTrustlines')]);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Handle delete trustlines by issuer
            const handleDeleteByIssuer = async () => {
                if (!issuerAddress || !StellarSdk.StrKey.isValidEd25519PublicKey(issuerAddress)) {
                    setError(t('invalidIssuer'));
                    return;
                }
                setError('');
                setIsLoading(true);
                try {
                    const issuerTrustlines = results; // Use displayed trustlines
                    if (issuerTrustlines.length > 0 && typeof issuerTrustlines[0] !== 'string') {
                        // Validate secret key first
                        if (!sourceSecret) {
                            setError(t('secretKeyEmpty'));
                            setIsLoading(false);
                            return;
                        }
                        if (!StellarSdk.StrKey.isValidEd25519SecretSeed(sourceSecret)) {
                            setError(t('secretKeyInvalid'));
                            setIsLoading(false);
                            return;
                        }
                        const keyPair = StellarSdk.Keypair.fromSecret(sourceSecret);
                        if (keyPair.publicKey() !== sourcePublicKey) {
                            setError(t('secretKeyMismatch'));
                            setIsLoading(false);
                            return;
                        }

                        setConfirmAction(() => async () => {
                            try {
                                console.log('Sending fetch to:', BACKEND_URL + '/delete-trustlines');
                                console.log('Request body:', { secretKey: sourceSecret, trustlines: issuerTrustlines });
                                const response = await fetch(`${BACKEND_URL}/delete-trustlines`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ secretKey: sourceSecret, trustlines: issuerTrustlines })
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(t('failedDeleteTrustlines', { error: result.error || 'Unknown error' }));
                                setResults([...result.messages, t('secretKeyCleared')]);
                                setTrustlines(await loadTrustlines(sourcePublicKey));
                                setSourceSecret('');
                                setShowSecretKey(false);
                            } catch (err) {
                                console.error('Fetch error:', err);
                                setError(err.message.includes('Failed to fetch')
                                    ? t('backendConnectError', { url: BACKEND_URL })
                                    : err.message);
                            }
                        });
                        setShowConfirm(true);
                    } else {
                        setResults([t('noIssuer', { issuer: issuerAddress })]);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // Search issuer addresses
            const handleIssuerSearch = async () => {
                if (!issuerAddress) {
                    setIssuerSearchResults([]);
                    return;
                }
                setError('');
                try {
                    const trustlines = await loadTrustlines(sourcePublicKey);
                    const matchingIssuers = [...new Set(
                        trustlines
                            .filter(t => t.assetIssuer.toLowerCase().includes(issuerAddress.toLowerCase()))
                            .map(t => t.assetIssuer)
                    )];
                    if (matchingIssuers.length > 0) {
                        setIssuerSearchResults(matchingIssuers);
                    } else {
                        setIssuerSearchResults([]);
                        setError(t('issuerSearchNoMatch', { search: issuerAddress }));
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            // Render confirmation modal
            const ConfirmationModal = () => (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div className="bg-white p-6 rounded-lg shadow-lg">
                        <h2 className="text-xl font-bold mb-4">{t('confirmTitle')}</h2>
                        <p className="mb-4">{t('confirmMessage')}</p>
                        <div className="flex justify-end space-x-4">
                            <button
                                onClick={async () => {
                                    setIsLoading(true);
                                    try {
                                        await confirmAction();
                                        setShowConfirm(false);
                                    } catch (err) {
                                        setError(err.message);
                                    } finally {
                                        setIsLoading(false);
                                    }
                                }}
                                className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
                                disabled={isLoading}
                            >
                                {t('yes')}
                            </button>
                            <button
                                onClick={() => {
                                    setShowConfirm(false);
                                    setSourceSecret('');
                                    setShowSecretKey(false);
                                }}
                                className="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
                            >
                                {t('cancel')}
                            </button>
                        </div>
                    </div>
                </div>
            );

            // Resolve federation address to public key
            async function resolveFederationAddress(federationAddress) {
                try {
                    const federationServer = new StellarSdk.FederationServer('https://federation.stellar.org');
                    const response = await federationServer.resolve(federationAddress);
                    if (!response.account_id) throw new Error('No account_id in federation response');
                    return response.account_id;
                } catch (error) {
                    throw new Error(t('failedFederation', { error: error.message }));
                }
            }

            // Load account trustlines
            async function loadTrustlines(publicKey) {
                try {
                    const account = await server.loadAccount(publicKey);
                    if (!account.balances) throw new Error(t('noBalances'));
                    const trustlines = account.balances
                        .filter(balance => balance.asset_type !== 'native' && balance.asset_code && balance.asset_issuer)
                        .map(balance => ({
                            assetCode: balance.asset_code,
                            assetIssuer: balance.asset_issuer,
                            creationDate: null // Placeholder for creation date
                        }));

                    // Fetch creation dates from operations endpoint
                    const operations = server.operations().forAccount(publicKey).order('desc').limit(200);
                    let cursor = null;
                    const trustlineMap = new Map(trustlines.map(t => [`${t.assetCode}:${t.assetIssuer}`, t]));

                    while (trustlineMap.size > 0) {
                        try {
                            const opResponse = cursor
                                ? await operations.cursor(cursor).call()
                                : await operations.call();
                            if (!opResponse.records || opResponse.records.length === 0) break;

                            for (const op of opResponse.records) {
                                if (op.type === 'change_trust' && op.asset_code && op.asset_issuer) {
                                    const key = `${op.asset_code}:${op.asset_issuer}`;
                                    if (trustlineMap.has(key)) {
                                        trustlineMap.get(key).creationDate = new Date(op.created_at);
                                        trustlineMap.delete(key);
                                    }
                                }
                            }
                            cursor = opResponse.next ? (await opResponse.next()).cursor : null;
                            if (!cursor) break;
                        } catch (opError) {
                            console.error('Error fetching operations:', opError);
                            throw new Error(t('errorFetchingOperations', { error: opError.message }));
                        }
                    }

                    return trustlines;
                } catch (error) {
                    throw new Error(t('failedLoadAccount', { publicKey, error: error.message }));
                }
            }

            return (
                <div className="container mx-auto p-4">
                    <div className="flex space-x-2 mb-4">
                        {availableLanguages.map(lang => (
                            <button
                                key={lang.code}
                                onClick={() => toggleLanguage(lang.code)}
                                className={`px-4 py-2 rounded flex items-center space-x-2 ${
                                    language === lang.code ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'
                                }`}
                                disabled={language === lang.code}
                            >
                                <span>{lang.flag}</span>
                                <span>{lang.name}</span>
                            </button>
                        ))}
                    </div>
                    <h1 className="text-2xl font-bold mb-4">{t('title')}</h1>
                    <p className="mb-4 text-sm text-gray-600">{t('secretKeyInfo')}</p>
                    {!sourcePublicKey ? (
                        <div className="mb-4">
                            <label className="block mb-2">{t('sourceLabel')}</label>
                            <input
                                type="text"
                                value={sourceInput}
                                onChange={(e) => setSourceInput(e.target.value)}
                                className="w-full p-2 border rounded"
                                placeholder={t('sourcePlaceholder')}
                            />
                            <button
                                onClick={handleSourceSubmit}
                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                disabled={isLoading}
                            >
                                {isLoading ? t('loading') : t('submitButton')}
                            </button>
                        </div>
                    ) : (
                        <div>
                            <p className="mb-4">{t('sourceWallet')} {sourcePublicKey}</p>
                            {!menuOption ? (
                                <div className="space-y-2">
                                    <button
                                        onClick={() => handleMenuOption('listAll')}
                                        className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 text-lg py-4"
                                    >
                                        {t('listAll')}
                                    </button>
                                    <button
                                        onClick={() => handleMenuOption('compare')}
                                        className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 text-lg py-4"
                                    >
                                        {t('compare')}
                                    </button>
                                    <button
                                        onClick={() => handleMenuOption('deleteAll')}
                                        className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 text-lg py-4"
                                    >
                                        {t('deleteAll')}
                                    </button>
                                    <button
                                        onClick={() => handleMenuOption('deleteByIssuer')}
                                        className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 text-lg py-4"
                                    >
                                        {t('deleteByIssuer')}
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    <button
                                        onClick={() => setMenuOption(null)}
                                        className="mb-4 bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
                                    >
                                        {t('backToMenu')}
                                    </button>
                                    {menuOption && (
                                        <p className="mb-4 text-gray-600">
                                            {t('currentMenu')} {menuOption === 'listAll' ? t('listAll') :
                                                            menuOption === 'compare' ? t('compare') :
                                                            menuOption === 'deleteAll' ? t('deleteAll') :
                                                            t('deleteByIssuer')}
                                        </p>
                                    )}
                                    {menuOption === 'listAll' && (
                                        <div>
                                            <button
                                                onClick={handleListAllTrustlines}
                                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                                disabled={isLoading}
                                            >
                                                {isLoading ? t('loading') : t('listTrustlines')}
                                            </button>
                                        </div>
                                    )}
                                    {menuOption === 'compare' && (
                                        <div>
                                            <label className="block mb-2">{t('destLabel')}</label>
                                            <input
                                                type="text"
                                                value={destinationPublicKey}
                                                onChange={(e) => setDestinationPublicKey(e.target.value)}
                                                className="w-full p-2 border rounded"
                                                placeholder={t('destPlaceholder')}
                                            />
                                            <button
                                                onClick={handleCompareTrustlines}
                                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                                disabled={isLoading}
                                            >
                                                {isLoading ? t('loading') : t('compareTrustlines')}
                                            </button>
                                            <div className="mt-4">
                                                <label className="block mb-2">{t('secretKeyLabel')}</label>
                                                <div className="flex space-x-2">
                                                    <input
                                                        type={showSecretKey ? 'text' : 'password'}
                                                        value={sourceSecret}
                                                        onChange={(e) => setSourceSecret(e.target.value)}
                                                        className="w-full p-2 border rounded"
                                                        placeholder={t('secretKeyPlaceholder')}
                                                    />
                                                    <button
                                                        onClick={() => setShowSecretKey(!showSecretKey)}
                                                        className="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300"
                                                    >
                                                        {showSecretKey ? t('hide') : t('show')}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {menuOption === 'deleteAll' && (
                                        <div>
                                            <button
                                                onClick={handleListAllTrustlines}
                                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                                disabled={isLoading}
                                            >
                                                {isLoading ? t('loading') : t('showAllTrustlines')}
                                            </button>
                                            <div className="mt-4">
                                                <label className="block mb-2">{t('secretKeyLabel')}</label>
                                                <div className="flex space-x-2">
                                                    <input
                                                        type={showSecretKey ? 'text' : 'password'}
                                                        value={sourceSecret}
                                                        onChange={(e) => setSourceSecret(e.target.value)}
                                                        className="w-full p-2 border rounded"
                                                        placeholder={t('secretKeyPlaceholder')}
                                                    />
                                                    <button
                                                        onClick={() => setShowSecretKey(!showSecretKey)}
                                                        className="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300"
                                                    >
                                                        {showSecretKey ? t('hide') : t('show')}
                                                    </button>
                                                </div>
                                            </div>
                                            <button
                                                onClick={handleDeleteAllTrustlines}
                                                className="mt-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 disabled:bg-gray-300"
                                                disabled={isLoading || results.length === 0 || typeof results[0] === 'string'}
                                            >
                                                {isLoading ? t('loading') : t('deleteAllButton')}
                                            </button>
                                        </div>
                                    )}
                                    {menuOption === 'deleteByIssuer' && (
                                        <div>
                                            <label className="block mb-2">{t('issuerLabel')}</label>
                                            <input
                                                type="text"
                                                value={issuerAddress}
                                                onChange={(e) => {
                                                    setIssuerAddress(e.target.value);
                                                    handleIssuerSearch();
                                                }}
                                                className="w-full p-2 border rounded"
                                                placeholder={t('issuerPlaceholder')}
                                            />
                                            {issuerSearchResults.length > 0 && (
                                                <div className="mt-2">
                                                    <ul className="border rounded p-2 max-h-40 overflow-y-auto">
                                                        {issuerSearchResults.map((issuer, index) => (
                                                            <li
                                                                key={index}
                                                                className="p-1 hover:bg-gray-200 cursor-pointer"
                                                                onClick={() => {
                                                                    setIssuerAddress(issuer);
                                                                    setIssuerSearchResults([]);
                                                                }}
                                                            >
                                                                {issuer}
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            )}
                                            <button
                                                onClick={async () => {
                                                    if (!issuerAddress || !StellarSdk.StrKey.isValidEd25519PublicKey(issuerAddress)) {
                                                        setError(t('invalidIssuer'));
                                                        return;
                                                    }
                                                    setError('');
                                                    setIsLoading(true);
                                                    try {
                                                        const trustlines = await loadTrustlines(sourcePublicKey);
                                                        const issuerTrustlines = trustlines.filter(t => t.assetIssuer === issuerAddress);
                                                        if (issuerTrustlines.length > 0) {
                                                            setResults(issuerTrustlines);
                                                        } else {
                                                            setResults([t('noIssuer', { issuer: issuerAddress })]);
                                                        }
                                                    } catch (err) {
                                                        setError(err.message);
                                                    } finally {
                                                        setIsLoading(false);
                                                    }
                                                }}
                                                className="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                                disabled={isLoading}
                                            >
                                                {isLoading ? t('loading') : t('showAllTrustlines')}
                                            </button>
                                            <div className="mt-4">
                                                <label className="block mb-2">{t('secretKeyLabel')}</label>
                                                <div className="flex space-x-2">
                                                    <input
                                                        type={showSecretKey ? 'text' : 'password'}
                                                        value={sourceSecret}
                                                        onChange={(e) => setSourceSecret(e.target.value)}
                                                        className="w-full p-2 border rounded"
                                                        placeholder={t('secretKeyPlaceholder')}
                                                    />
                                                    <button
                                                        onClick={() => setShowSecretKey(!showSecretKey)}
                                                        className="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300"
                                                    >
                                                        {showSecretKey ? t('hide') : t('show')}
                                                    </button>
                                                </div>
                                            </div>
                                            <button
                                                onClick={handleDeleteByIssuer}
                                                className="mt-2 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 disabled:bg-gray-300"
                                                disabled={isLoading || results.length === 0 || typeof results[0] === 'string'}
                                            >
                                                {isLoading ? t('loading') : t('deleteByIssuerButton')}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                    {error && <p className="text-red-500 mt-4">{error}</p>}
                    {results.length > 0 && (
                        <div className="mt-4">
                            <h2 className="text-xl font-bold">{t('results')}</h2>
                            {typeof results[0] === 'string' ? (
                                <ul className="list-disc pl-5">
                                    {results.map((result, index) => (
                                        <li key={index}>{result.includes('No trustlines found for issuer') ? t('noIssuer', { issuer: issuerAddress }) : result}</li>
                                    ))}
                                </ul>
                            ) : (
                                <div>
                                    <table className="w-full border-collapse border border-gray-300">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th
                                                    className={`border border-gray-300 p-2 cursor-pointer hover:bg-gray-200 ${sortColumn === 'assetCode' ? 'font-bold bg-gray-200' : ''}`}
                                                    onClick={() => handleSort('assetCode')}
                                                >
                                                    {t('assetCode')} {sortColumn === 'assetCode' ? (sortDirection === 'asc' ? 'â†‘' : 'â†“') : ''}
                                                </th>
                                                <th
                                                    className={`border border-gray-300 p-2 cursor-pointer hover:bg-gray-200 ${sortColumn === 'assetIssuer' ? 'font-bold bg-gray-200' : ''}`}
                                                    onClick={() => handleSort('assetIssuer')}
                                                >
                                                    {t('issuer')} {sortColumn === 'assetIssuer' ? (sortDirection === 'asc' ? 'â†‘' : 'â†“') : ''}
                                                </th>
                                                <th
                                                    className={`border border-gray-300 p-2 cursor-pointer hover:bg-gray-200 ${sortColumn === 'creationDate' ? 'font-bold bg-gray-200' : ''}`}
                                                    onClick={() => handleSort('creationDate')}
                                                >
                                                    {t('creationDate')} {sortColumn === 'creationDate' ? (sortDirection === 'asc' ? 'â†‘' : 'â†“') : ''}
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getPaginatedTrustlines(getSortedAndFilteredTrustlines(results)).map((result, index) => (
                                                <tr key={index}>
                                                    <td className="border border-gray-300 p-2">{result.assetCode}</td>
                                                    <td className="border border-gray-300 p-2">{result.assetIssuer}</td>
                                                    <td className="border border-gray-300 p-2">
                                                        {result.creationDate
                                                            ? result.creationDate.toLocaleString()
                                                            : t('unknownDate')}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <div className="mt-4 flex items-center justify-between">
                                        <button
                                            onClick={() => setCurrentPage(prev => Math.max(prev - 1, 0))}
                                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 disabled:bg-gray-300"
                                            disabled={currentPage === 0}
                                        >
                                            {t('previous')}
                                        </button>
                                        <span>
                                            Page {currentPage + 1} ({currentPage * ITEMS_PER_PAGE + 1}-{Math.min((currentPage + 1) * ITEMS_PER_PAGE, results.length)} of {results.length})
                                        </span>
                                        <button
                                            onClick={() => setCurrentPage(prev => Math.min(prev + 1, Math.ceil(results.length / ITEMS_PER_PAGE) - 1))}
                                            className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 disabled:bg-gray-300"
                                            disabled={currentPage >= Math.ceil(results.length / ITEMS_PER_PAGE) - 1}
                                        >
                                            {t('next')}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {showBackToTop && (
                        <button
                            onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                            className="fixed bottom-16 right-8 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 z-10"
                        >
                            {t('backToTop')}
                        </button>
                    )}
                    {showConfirm && <ConfirmationModal />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
